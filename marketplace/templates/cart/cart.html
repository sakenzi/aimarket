{% extends "base/base.html" %}
{% load humanize %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-black text-gray-900 mb-8">–ö–æ—Ä–∑–∏–Ω–∞</h1>

    {% if items %}
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Cart Items -->
        <div class="flex-1 space-y-4" id="cart-items">
            {% for item in items %}
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 flex gap-4 items-center" id="cart-item-{{ item.id }}">
                {% with item.product.get_main_image as img %}
                <a href="{% url 'products:detail' item.product.slug %}" class="shrink-0">
                    {% if img %}
                    <img src="{{ img.image.url }}" alt="{{ item.product.name }}"
                         class="w-20 h-20 object-cover rounded-xl">
                    {% else %}
                    <div class="w-20 h-20 bg-yellow-50 rounded-xl flex items-center justify-center text-3xl">üì¶</div>
                    {% endif %}
                </a>
                {% endwith %}

                <div class="flex-1 min-w-0">
                    <a href="{% url 'products:detail' item.product.slug %}" class="font-semibold text-gray-900 hover:text-yellow-700 transition line-clamp-2 block text-sm mb-1">
                        {{ item.product.name }}
                    </a>
                    <p class="text-xs text-gray-400 mb-2">–ê—Ä—Ç.: {{ item.product.sku }}</p>
                    <p class="text-lg font-black text-gray-900">{{ item.product.price|floatformat:0|intcomma }}‚ÇΩ</p>
                </div>

                <!-- Qty Controls -->
                <div class="flex flex-col items-end gap-3">
                    <div class="flex items-center border border-gray-200 rounded-xl overflow-hidden bg-white">
                        <button onclick="updateQty({{ item.id }}, {{ item.quantity|add:'-1' }})"
                                class="px-3 py-2 text-gray-600 hover:bg-gray-50 transition font-bold">‚àí</button>
                        <span class="px-3 py-2 font-bold text-gray-900 min-w-[2.5rem] text-center" id="qty-{{ item.id }}">{{ item.quantity }}</span>
                        <button onclick="updateQty({{ item.id }}, {{ item.quantity|add:'1' }})"
                                class="px-3 py-2 text-gray-600 hover:bg-gray-50 transition font-bold">+</button>
                    </div>
                    <p class="text-base font-black text-gray-900" id="item-total-{{ item.id }}">
                        {{ item.get_total_price|floatformat:0|intcomma }}‚ÇΩ
                    </p>
                    <button onclick="removeItem({{ item.id }})"
                            class="text-red-400 hover:text-red-600 text-xs font-medium transition flex items-center gap-1">
                        üóë –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Order Summary -->
        <div class="w-full lg:w-80">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-24">
                <h2 class="font-black text-xl text-gray-900 mb-5">–ò—Ç–æ–≥–æ</h2>
                <div class="space-y-3 mb-5">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">–¢–æ–≤–∞—Ä—ã ({{ cart.get_items_count }})</span>
                        <span class="font-semibold" id="subtotal">{{ cart.get_total_price|floatformat:0|intcomma }}‚ÇΩ</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                        {% if cart.get_total_price >= 1000 %}
                        <span class="font-semibold text-green-600">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                        {% else %}
                        <span class="font-semibold">299‚ÇΩ</span>
                        {% endif %}
                    </div>
                    <div class="border-t border-gray-100 pt-3 flex justify-between">
                        <span class="font-bold text-gray-900">–ö –æ–ø–ª–∞—Ç–µ</span>
                        <span class="font-black text-xl text-gray-900" id="grand-total">
                            {% if cart.get_total_price >= 1000 %}{{ cart.get_total_price|floatformat:0|intcomma }}{% else %}{{ cart.get_total_price|add:299|floatformat:0|intcomma }}{% endif %}‚ÇΩ
                        </span>
                    </div>
                </div>
                {% if cart.get_total_price < 1000 %}
                <div class="bg-green-50 text-green-700 text-xs p-3 rounded-xl mb-4">
                    üöö –î–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏: <strong>{{ 1000|add:-cart.get_total_price|floatformat:0 }}‚ÇΩ</strong>
                </div>
                {% endif %}
                <a href="{% url 'orders:checkout' %}" class="block w-full text-center bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-black text-lg py-4 rounded-xl transition hover:shadow-md">
                    –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Üí
                </a>
                <a href="{% url 'products:catalog' %}" class="block w-full text-center text-gray-500 hover:text-gray-700 text-sm mt-3 transition">
                    ‚Üê –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                </a>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty Cart -->
    <div class="text-center py-24">
        <div class="text-8xl mb-6">üõí</div>
        <h2 class="text-2xl font-black text-gray-700 mb-3">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
        <p class="text-gray-500 mb-8">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å</p>
        <div class="flex gap-4 justify-center">
            <a href="{% url 'products:catalog' %}" class="btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
            <a href="{% url 'ai_chat:chat' %}" class="btn-secondary">ü§ñ AI –ø–æ–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
const CSRF = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';

async function updateQty(itemId, qty) {
    if (qty < 1) { removeItem(itemId); return; }
    const res = await fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' },
        body: `quantity=${qty}`
    });
    const data = await res.json();
    if (data.success) {
        document.getElementById(`qty-${itemId}`).textContent = qty;
        document.getElementById(`item-total-${itemId}`).textContent = parseInt(data.item_total).toLocaleString('ru') + '‚ÇΩ';
        document.getElementById('subtotal').textContent = parseInt(data.cart_total).toLocaleString('ru') + '‚ÇΩ';
        document.querySelectorAll('.cart-badge').forEach(el => el.textContent = data.cart_count);
    }
}

async function removeItem(itemId) {
    const el = document.getElementById(`cart-item-${itemId}`);
    el.style.opacity = '0.5';
    const res = await fetch(`/cart/remove/${itemId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' }
    });
    const data = await res.json();
    if (data.success) {
        el.remove();
        document.querySelectorAll('.cart-badge').forEach(e => e.textContent = data.cart_count);
        if (data.cart_count === 0) location.reload();
    }
}
</script>
{% endblock %}